<!DOCTYPE html>
<html>

<head>
    <title>File Upload</title>
    <style>
        form {
            display: block;
            margin: 20px auto;
            border-radius: 10px;
            padding: 15px
        }
        
        #progressbox {
            position: relative;
            width: 400px;
            border: 1px solid #ddd;
            padding: 1px;
            border-radius: 3px;
        }
        
        #progressbar {
            background-color: lightblue;
            width: 0%;
            height: 20px;
            border-radius: 4px;
        }
        
        #percent {
            position: absolute;
            display: inline-block;
            top: 3px;
            left: 48%;
        }
        
        .btn-file {
            position: relative;
            overflow: hidden;
        }
        
        .btn-file input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            background: red;
            cursor: inherit;
            display: block;
        }
        
        input[readonly] {
            background-color: white !important;
            cursor: text !important;
        }
    </style>
    <script src="js/jquery.js"></script>
    <script src="js/jquery.form.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/bootstrap.min.js"></script>
    <script type="text/javascript">
        var authorizationToken = window.opener.mainViewModel.loginViewModel.userProfile.authorizationToken();
        var image_deployments = window.opener.image_type_upload;
        var image_format = window.opener.image_format_upload;


        var urlToUploadMetadata = "/v1/images";
        var blob, BYTES_PER_CHUNK, SIZE, NUM_CHUNKS, start, end;
        var fileName = "";
        var currentFileName = "";
        var refreshIntervalId = 0;
        var defaultSessionExtensionInterval = 20 * 60 * 1000;


        function validateName(fileName) {
            fileName = fileName.split(' '); //we split the string in an array of strings using     whitespace as separator
            return (fileName.length == 1); //true when there is only one word, false else.
        }


        function extendSessionIfNeeded() {
            var cd = new Date();
            console.log("Refreshing token at : " + cd);
            var formData = {
                "authorization_token": authorizationToken
            }
            $.ajax({
                type: "PATCH",
                url: "/v1/login/extend",
                data: JSON.stringify(formData),
                contentType: "application/json",
                dataType: 'json',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': "Token " + authorizationToken
                },
                success: function(data, status) {
                    console.log("YAY !!! Got extended date from server for token : " + authorizationToken);
                    var token = data.value;
                    console.log("Expiry date for token " + authorizationToken + " extended");
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log("Expiry date for token " + authorizationToken + " extension failed");
                }
            });
        }

        function scheduleSessionRefresh(upload_size) {
            var numberOfCallsRequired = (upload_size / 1048576) / 10;
            var timeTakenForCalls = numberOfCallsRequired * 5;

            console.log("Size of file being uploaded = " + numberOfCallsRequired);
            console.log("Number of calls required : " + numberOfCallsRequired);
            console.log("Time taken for calls :" + timeTakenForCalls);

            var authToken = encodeURIComponent(authorizationToken);
            console.log("Token sent with GET : " + authToken);
            $.ajax({
                cache: false,
                type: "GET",
                url: "/v1/login?token=" + authToken + "&randomStr=" + new Date().getTime(),
                dataType: 'json',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': "Token " + authorizationToken
                },
                success: function(data, status) {
                    console.log("Got expiry date from server for token : " + authorizationToken);

                    var currentDate = data.current_date;
                    var expiryDate = data.expiry_date;
                    var interval = data.timeout_interval;
                    console.log("currentDate - " + currentDate + " :: expiryDate - " + expiryDate + " interval - " + interval);
                    var timeToExpiry = expiryDate - currentDate;
                    if (timeToExpiry <= (1000 * timeTakenForCalls)) {

                        extendSessionIfNeeded();
                        if (refreshIntervalId == 0) {
                            console.log("***********************************************");
                            refreshIntervalId = setInterval(function() {
                                extendSessionIfNeeded();
                            }, ((interval * 60 * 1000) - 10000));
                            console.log("Scheduled session extender with ID : " + refreshIntervalId);
                        }
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log("&&&&&&&&& Cannot retrieve details for " + token);
                }
            });

        }


        function validateForm() {
            $('#upload').prop('disabled', true);
            var x = document.forms["myform"]["myfile"].value;
            if (x == null || x == "") {
                alert("First Choose File Please...");
                $('#upload').prop('disabled', false);
                return false;
            }
            currentFileName = document.getElementById('myfile').files[0].name;
            if ($('#image_name_input').val() != "" && $('#image_name_input').val() != null) {
                fileName = $('#image_name_input').val();
            } else {
                fileName = currentFileName;
            }
            if (!validateName(fileName)) {
                $('#upload').prop('disabled', false);
                $('#file_upload_window_modal_body').html("Provide correct file name");
                $("#file_upload_window_modal").modal({
                    backdrop: "static"
                });
                $('body').removeClass("modal-open");
                return false;
            }
            blob = document.getElementById('myfile').files[0];
            SIZE = blob.size;
            scheduleSessionRefresh(SIZE);

            var image_id;
            var upload_size = Math.floor(SIZE / 1024);

            var xhrmdt = new XMLHttpRequest();
            xhrmdt.open('POST', urlToUploadMetadata, true);
            xhrmdt.setRequestHeader("Content-Type", "application/json");
            xhrmdt.setRequestHeader("Authorization", "Token " + authorizationToken);
            upload_data = {
                'image_deployments': image_deployments,
                'image_format': image_format,
                'image_name': fileName,
                'image_size': SIZE
            };
            if (image_deployments == "Docker") {
                upload_data.repository = $('#input_repo').val();
                upload_data.tag = $('#input_tag').val();
                if (upload_data.tag == "" || upload_data.repository == "") {
                    alert("Please provide repository and tag...");
                    return false;
                }

            }
            xhrmdt.send(JSON.stringify(upload_data));
            xhrmdt.onreadystatechange = function(e) {

                    if (xhrmdt.readyState === 4) {
                        if (xhrmdt.status === 200) {

                            var myArr = JSON.parse(xhrmdt.responseText);
                            image_id = myArr.id;
                            if (myArr.image_upload_status  == "Error") {
                                $('#file_upload_window_modal_body').html(myArr.details);
                                $("#file_upload_window_modal").modal({
                                    backdrop: "static"
                                });
                                $('body').removeClass("modal-open");
                                $('#upload').prop('disabled', false);
                                return false;
                            }
                            BYTES_PER_CHUNK = 1048576 * 10; //10MB
                            start = 0;
                            end = BYTES_PER_CHUNK;
                            upload_chunks(image_id, start, end);

                        } else if (xhrmdt.status === 401) {
                            alert("Session timed out");
                            window.opener.mainViewModel.loginViewModel.userProfile.authenticated(false);
                            window.opener.mainViewModel.loginViewModel.userProfile.authorizationToken(null);
                            window.opener.location.reload();
                            window.close();
                        } else {
                            console.log("Clearing interval : " + refreshIntervalId);
                            clearInterval(refreshIntervalId);
                            alert("Failed to save image upload metdata.");
                            $('#upload').prop('disabled', false);
                            return false;
                        }
                    }
                }
                //NUM_CHUNKS = Math.max(Math.ceil(SIZE / BYTES_PER_CHUNK), 1);
        }

        function upload_chunks(image_id, start, end) {

            if (start < SIZE) {
                //alert(image_id);		
                var blobslice = blob.slice(start, end);
                var xhr = new XMLHttpRequest();
                var urlToUpload = "/v1/rpc/images/content/" + image_id;
                xhr.open('POST', urlToUpload, true);
                xhr.setRequestHeader("Content-type", "application/octet-stream");
                xhr
                    .setRequestHeader("Authorization", "Token " + authorizationToken);
                xhr.send(blobslice);

                xhr.onreadystatechange = function(e) {

                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            var percentComplete;
                            if (end < SIZE) {
                                percentComplete = Math.floor((end / SIZE) * 100);

                            } else {

                                percentComplete = 100;
                            }

                            $("#progressbar").width(percentComplete + '%');
                            $("#percent").html(percentComplete + '%');

                            if (percentComplete > 0) {
                                $("#message")
                                    .html(
                                        "<font color='red'>File Upload is in progress</font>");
                            }
                            start = end;

                            end = start + BYTES_PER_CHUNK;

                            upload_chunks(image_id, start, end);

                        } else if (xhrmdt.status === 401) {
                            alert("Session timed out");
                            window.opener.mainViewModel.loginViewModel.userProfile.authenticated(false);
                            window.opener.mainViewModel.loginViewModel.userProfile.authorizationToken(null);
                            window.opener.location.reload();
                            window.close();
                        } else {
                            console.log("Clearing interval : " + refreshIntervalId);
                            clearInterval(refreshIntervalId);
                            alert("File upload failed..");
                            $('#upload').prop('disabled', false);
                        }
                    }
                }

            } else {
                if (image_deployments == 'Docker') {
					var dockerData = { "image_id" : image_id};
                    $("#message").html("<font color='green'>Loading Image...</font>");
                    $.ajax({
                        type: "POST",
                        url: "/v1/rpc/docker-load",
						contentType: "application/json",
                        dataType: "json",
						data: JSON.stringify(dockerData),
                        headers: {
                            "Authorization": "Token " + authorizationToken
                        },
                        success: function(data) {
                            if (data.error) {
                                alert("Error in loading docker image");
                                $('#upload').prop('disabled', false);
                                return;
                            }
							dockerData.repository = upload_data.repository;
							dockerData.tag = upload_data.tag + "_source";
							$.ajax({
								type: "POST",
								url: "/v1/rpc/docker-tag",
								dataType: "json",
								contentType: "application/json",
								data: JSON.stringify(dockerData),
								headers: {
									"Authorization": "Token " + authorizationToken
								},
								success: function(data) {
									if (data.error) {
										alert("Error in loading docker image");
										$('#upload').prop('disabled', false);
										return;
									}
									$.ajax({
										type: "DELETE",
										url: "/v1/rpc/docker-rmi/" + image_id,
										dataType: "json",
										headers: {
											"Authorization": "Token " + authorizationToken
										},
										success: function(data) {
											if (data.error) {
												alert("Error in loading docker image");
												$('#upload').prop('disabled', false);
												return;
											}
											$("#message").html("<font color='blue'>Your file has been uploaded!</font>");
											document.getElementById("upload").onclick = function() {
												this.disabled = false;
											}
											alert("Image upload successfully completed");
											var goToTPDiv = $("#goToTrustPolicyPageDiv", opener.document);
											var uploadBtnDiv = $("#gotoUploadWindowDiv", opener.document);
											goToTPDiv.show();
											$('#upload').prop('disabled', false);
											goToTPDiv.css("display", "block");							
											window.close();
											return;
										}
									});
								}
							});
                        }
                    });
                } else {
                    $("#message").html("<font color='blue'>Your file has been uploaded!</font>");
                    document.getElementById("upload").onclick = function() {
                        this.disabled = false;
                    }
                    alert("Image upload successfully completed");
                    var goToTPDiv = $("#goToTrustPolicyPageDiv", opener.document);
                    var uploadBtnDiv = $("#gotoUploadWindowDiv", opener.document);
                    //uploadBtnDiv.hide();
                    goToTPDiv.show();
                    $('#upload').prop('disabled', false);
                	$('#upload').prop('disabled', false);
                	goToTPDiv.css("display", "block");
                    window.close();
                }
            }
        }
    </script>
    <script>
        $(document).on(
            'change',
            '.btn-file :file',
            function() {
                var input = $(this),
                    numFiles = input.get(0).files ? input
                    .get(0).files.length : 1,
                    label = input.val().replace(
                        /\\/g, '/').replace(/.*\//, '');
                input.trigger('fileselect', [numFiles, label]);
            });

        $(document).ready(
            function() {
				$('[data-toggle="tooltip"]').tooltip();
                if (image_deployments == "Docker") {
                    $('#repo_tag').show();
                }
                $('.btn-file :file').on(
                    'fileselect',
                    function(event, numFiles, label) {
                        var input = $(this).parents('.input-group').find(
                                ':text'),
                            log = numFiles > 1 ? numFiles + ' files selected' : label;

                        if (input.length) {
                            input.val(log);
                        } else {
                            if (log)
                                alert(log);
                        }
                    });
            });
    </script>

</head>

<body>

    <form id="UploadForm" name="myform" method="post" enctype="multipart/form-data">
        <h4>Please Select File ::</h4>
        <div class="input-group">
            <span class="input-group-btn"> <span
				class="btn btn-primary btn-file"> Browse&hellip; <input
					type="file" id="myfile" name="myfile">
			</span>
            </span>
            <input type="text" class="form-control" readonly>
        </div>
        <br />
        <input type="text" id="image_name_input" class="form-control" placeholder="Enter Image Name with extension (optional)...">
        <br />
        <div id="repo_tag" style="display: none;">
            <input type="text" id="input_repo" data-toggle="tooltip" title="Repo of Docker Image" class="form-control" placeholder="Enter Repository">
            <br />
            <input type="text" id="input_tag" data-toggle="tooltip" title="Tag of Docker Image" class="form-control" placeholder="Enter Tag">
        </div>
        <br />
        <input class="btn btn-primary" id="upload" type="button" onclick="validateForm()" value="Upload">
        <div id="progressbox">
            <div id="progressbar"></div>
            <div id="percent">0%</div>
        </div>
        <br />
        <div id="message"></div>
        <div>
            <font color="red">Note : Please Don't Close This Window when
				upload is in progress...!!!</font>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="file_upload_window_modal" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
							<div id="file_upload_window_modal_body"></div>
						</h4>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Okay</button>
                    </div>
                </div>

            </div>
        </div>
    </form>



</body>

</html>